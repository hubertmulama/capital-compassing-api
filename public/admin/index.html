<script>
// Admin dashboard JavaScript - UPDATED FOR NEW SCHEMA

// Load dashboard stats - UPDATED
async function refreshStats() {
    const statsGrid = document.getElementById('statsGrid');
    if (!statsGrid) return;
    
    const statCards = statsGrid.querySelectorAll('.stat-number');
    if (statCards.length === 0) return;
    
    // Show loading
    statCards.forEach(card => card.textContent = '...');
    
    try {
        const queries = [
            "SELECT COUNT(*) as count FROM users WHERE role = 'client'",  // Changed from clients
            "SELECT COUNT(*) as count FROM eas",
            "SELECT COUNT(*) as count FROM trading_pairs",
            "SELECT COUNT(*) as count FROM account_details"
        ];
        
        const results = await Promise.all(queries.map(query => 
            fetch('/api/admin?action=data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sql: query })
            }).then(r => r.json())
        ));
        
        // Update stats
        results.forEach((result, index) => {
            if (result.success && statCards[index]) {
                statCards[index].textContent = result.rows[0].count;
            }
        });
        
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Load table data - UPDATED
async function loadTable(tableName) {
    console.log('Loading table:', tableName);
    
    const elementMap = {
        'users': 'clientsResult',  // Now showing users instead of clients
        'eas': 'easResult', 
        'trading_pairs': 'tradingResult'
    };
    
    const elementId = elementMap[tableName];
    const resultDiv = document.getElementById(elementId);
    
    if (!resultDiv) {
        console.error('Element not found:', elementId);
        return;
    }
    
    resultDiv.innerHTML = 'Loading...';
    
    try {
        let query = `SELECT * FROM ${tableName} ORDER BY id LIMIT 20;`;
        
        // Special queries for joined tables - UPDATED
        if (tableName === 'client_eas') {
            query = `
                SELECT ce.*, u.name as user_name, ea.name as ea_name 
                FROM client_eas ce
                LEFT JOIN users u ON ce.client_id = u.id
                LEFT JOIN eas ea ON ce.ea_id = ea.id
                ORDER BY ce.id LIMIT 20;
            `;
        } else if (tableName === 'mt5_account_names') {
            query = `
                SELECT man.*, u.name as user_name 
                FROM mt5_account_names man
                LEFT JOIN users u ON man.user_id = u.id
                ORDER BY man.id LIMIT 20;
            `;
        } else if (tableName === 'ea_pair_assignments') {
            query = `
                SELECT epa.*, ea.name as ea_name, tp.pair as pair_name 
                FROM ea_pair_assignments epa
                LEFT JOIN eas ea ON epa.ea_id = ea.id
                LEFT JOIN trading_pairs tp ON epa.pair_id = tp.id
                ORDER BY epa.id LIMIT 20;
            `;
        } else if (tableName === 'users') {
            query = `
                SELECT id, name, email, role, state, created_at 
                FROM users 
                ORDER BY id LIMIT 20;
            `;
        }
        
        const response = await fetch('/api/admin?action=data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sql: query })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.rows.length > 0) {
                resultDiv.innerHTML = createTableHTML(data.rows, tableName);
            } else {
                resultDiv.innerHTML = '<div style="color: green;">✅ No data found</div>';
            }
        } else {
            resultDiv.innerHTML = '<div style="color: red;">❌ Error: ' + data.error + '</div>';
        }
    } catch (error) {
        resultDiv.innerHTML = '<div style="color: red;">❌ Request failed: ' + error.message + '</div>';
    }
}

// Update the button handlers in the HTML - UPDATED
function updateButtonHandlers() {
    // Update the "View Clients" button to show users
    const clientsBtn = document.querySelector('button[onclick="loadTable(\'clients\')"]');
    if (clientsBtn) {
        clientsBtn.setAttribute('onclick', "loadTable('users')");
    }
    
    // Update the "Client Stats" button
    const clientStatsBtn = document.querySelector('button[onclick*=\"client stats\"]');
    if (clientStatsBtn) {
        clientStatsBtn.setAttribute('onclick', `runQuery('SELECT u.*, COUNT(man.id) as mt5_accounts FROM users u LEFT JOIN mt5_account_names man ON u.id = man.user_id WHERE u.role = \\'client\\' GROUP BY u.id;')`);
    }
}

// Initialize dashboard
function initializeDashboard() {
    const user = checkAuth();
    if (!user) return;
    
    console.log('Dashboard initialized for:', user.email, 'Role:', user.role);
    initializeTabs();
    refreshStats();
    updateButtonHandlers();
}

// Update predefined queries in the HTML
document.addEventListener('DOMContentLoaded', function() {
    // Update the SQL examples to use users table
    const sqlEditor = document.getElementById('sqlEditor');
    if (sqlEditor) {
        sqlEditor.value = "SELECT * FROM users WHERE role = 'client' LIMIT 5;";
    }
    
    // Update test buttons
    const testClientsBtn = document.querySelector('button[onclick="runQuery(\'SELECT * FROM clients LIMIT 5;\')"]');
    if (testClientsBtn) {
        testClientsBtn.setAttribute('onclick', "runQuery('SELECT * FROM users WHERE role = \\'client\\' LIMIT 5;')");
        testClientsBtn.textContent = 'Test Users';
    }
});

// Auto-initialize if on dashboard page
if (document.querySelector('.dashboard')) {
    document.addEventListener('DOMContentLoaded', initializeDashboard);
}
</script>
